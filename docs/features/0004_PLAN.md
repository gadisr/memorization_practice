# Feature 0004: Recall Verification with Text Input

## Brief Context

Add text input recall verification to training sessions. Users will type the letter pairs they recall instead of just entering a count. The system validates their input against the actual pairs shown during the session and provides detailed feedback. **Flash Pairs uses unordered matching (order doesn't matter), while all other drill types require exact sequential order.**

---

## Phase 1: Data Layer & Type Definitions

### 1.1 Update TypeScript Types

**File:** `src/types.ts`

Add new fields to `SessionData`:
```typescript
export interface SessionData {
  // ... existing fields ...
  userRecall?: string;              // Raw user input (e.g., "AB CD EF")
  recallValidation?: RecallValidation;  // Detailed validation results
}

export interface RecallValidation {
  isOrderRequired: boolean;         // Based on drill type
  correctPairs: string[];           // Pairs recalled correctly
  incorrectPairs: string[];         // Pairs recalled incorrectly
  missedPairs: string[];           // Pairs not recalled
  extraPairs: string[];            // Pairs user added that weren't in session
  accuracy: number;                // Percentage correct
}
```

### 1.2 Backend Schema Updates

**File:** `backend/src/models/session.py`

Add column to `Session` model:
```python
user_recall = Column(Text, nullable=True)
recall_validation = Column(JSONB, nullable=True)
```

**File:** `backend/src/schemas/session.py`

Update `SessionCreate` and `SessionResponse`:
```python
user_recall: Optional[str] = None
recall_validation: Optional[Dict[str, Any]] = None
```

**Migration File:** `backend/alembic/versions/004_add_recall_verification.py`
- Add `user_recall` TEXT column to `sessions` table
- Add `recall_validation` JSONB column to `sessions` table

---

## Phase 2A: Recall Validation Logic

### 2.1 Create Recall Validator Service

**New File:** `src/services/recall-validator.ts`

```typescript
/**
 * Validates user recall against actual session pairs
 */
export function validateRecall(
  userInput: string,
  actualPairs: LetterPair[],
  drillType: DrillType
): RecallValidation

/**
 * Parse user input into array of pairs
 * Handles formats: "AB CD EF", "AB,CD,EF", "ABCDEF", "A B C D E F"
 */
export function parseRecallInput(input: string): string[]

/**
 * Check if drill type requires ordered recall
 */
export function isOrderRequired(drillType: DrillType): boolean

/**
 * Validate with unordered matching (Flash Pairs)
 * - Extract all pairs from user input
 * - Check if all actual pairs are present (ignoring order)
 * - Identify missing and extra pairs
 */
function validateUnordered(
  userPairs: string[],
  actualPairs: string[]
): RecallValidation

/**
 * Validate with ordered matching (all other drills)
 * - Compare position by position
 * - Mark each position as correct/incorrect
 * - Identify missing and extra pairs
 */
function validateOrdered(
  userPairs: string[],
  actualPairs: string[]
): RecallValidation

/**
 * Normalize pair format (handle "AB" vs "BA")
 * For Flash Pairs, treat "AB" and "BA" as equivalent
 */
function normalizePair(pair: string): string
```

**Algorithm Details:**

**Unordered Validation (Flash Pairs):**
1. Parse user input into array of pairs
2. Normalize each pair (sort letters: "BA" → "AB")
3. Create sets of normalized actual and user pairs
4. correctPairs = intersection of both sets
5. missedPairs = actual pairs not in user set
6. extraPairs = user pairs not in actual set
7. Calculate accuracy = correctPairs.length / actualPairs.length * 100

**Ordered Validation (Other Drills):**
1. Parse user input into array of pairs
2. For each position i in actualPairs:
   - If userPairs[i] exists and matches actualPairs[i]: mark as correct
   - Otherwise: mark as incorrect or missing
3. Identify extra pairs beyond actualPairs.length
4. Calculate accuracy based on position matches

### 2.2 Update Session Manager

**File:** `src/services/session-manager.ts`

Modify `finalizeSession`:
```typescript
export async function finalizeSession(
  userRecall: string,          // Changed from recall: number
  quality: number,
  notes?: string
): Promise<SessionData>
```

Implementation:
1. Parse and validate user recall input
2. Call `validateRecall()` to get validation results
3. Set `session.userRecall = userRecall`
4. Set `session.recallValidation = validationResults`
5. Set `session.recallAccuracy = validationResults.accuracy`
6. Save session

---

## Phase 2B: UI Integration

### 2.3 Update Rating Screen HTML

**File:** `public/index.html`

Replace the recall number input section (lines ~94-98) with:

```html
<div class="form-group">
  <label for="recall-text-input">Enter Recalled Letter Pairs</label>
  <textarea 
    id="recall-text-input" 
    class="input-field recall-textarea" 
    rows="4" 
    placeholder="Type the letter pairs you remember (e.g., AB CD EF or ABCDEF)"
  ></textarea>
  <p id="recall-hint" class="help-text"></p>
</div>

<!-- Validation feedback (hidden initially) -->
<div id="recall-feedback" class="recall-feedback hidden">
  <h3>Recall Results</h3>
  <div id="recall-stats" class="recall-stats"></div>
  <div id="recall-details" class="recall-details"></div>
</div>
```

### 2.4 Update Renderer

**File:** `src/ui/renderer.ts`

Modify `renderRatingScreen`:
```typescript
export function renderRatingScreen(
  metric: QualityMetric, 
  pairCount: number,
  drillType: DrillType  // Add parameter
): void
```

Update implementation:
1. Set hint text based on drill type:
   - Flash Pairs: "Order doesn't matter - just recall all pairs"
   - Others: "Enter pairs in the exact order they were shown"
2. Remove the old number input references
3. Focus on the textarea

**New Function:** `src/ui/renderer.ts`

```typescript
export function renderRecallFeedback(validation: RecallValidation): void
```

Display validation results:
1. Show accuracy percentage with color coding
2. List correct pairs (green check marks)
3. List missed pairs (red X marks)
4. List incorrect pairs (yellow warning)
5. List extra pairs if any (gray info)
6. Use visual indicators (✓, ✗, ⚠)

### 2.5 Update App Event Handler

**File:** `src/app.ts`

Modify `handleNextPair` (line 261):
```typescript
// When session complete, pass drillType to renderRatingScreen
renderRatingScreen(metric, session.pairCount, session.drillType);
```

Modify `handleSaveSession` (line 306):
```typescript
async function handleSaveSession(): Promise<void> {
  const session = getActiveSession();
  if (!session) return;
  
  const recallTextInput = document.getElementById('recall-text-input') as HTMLTextAreaElement;
  const notesInput = document.getElementById('notes-input') as HTMLTextAreaElement;
  const qualityRadios = document.querySelectorAll('input[name="quality"]:checked');
  
  if (qualityRadios.length === 0) {
    showNotification('Please select a quality rating', 'error');
    return;
  }
  
  const userRecall = recallTextInput.value.trim();
  
  if (!userRecall) {
    showNotification('Please enter your recalled pairs', 'error');
    return;
  }
  
  const quality = parseInt((qualityRadios[0] as HTMLInputElement).value, 10);
  const notes = notesInput.value.trim();
  
  // Validation will happen inside finalizeSession
  try {
    const completedSession = await finalizeSession(userRecall, quality, notes || undefined);
    
    // Show validation feedback
    if (completedSession.recallValidation) {
      renderRecallFeedback(completedSession.recallValidation);
      
      // Delay navigation to let user see results
      setTimeout(async () => {
        showNotification('Session saved successfully!', 'success');
        const sessions = await getAllSessions();
        const notationSessions = await getAllNotationSessions();
        renderDashboard(sessions, notationSessions);
        showScreen('dashboard-screen');
        clearKeyboardCallbacks();
      }, 3000);
    }
  } catch (error) {
    console.error('Error saving session:', error);
    showNotification('Error saving session', 'error');
  }
}
```

### 2.6 Styling Updates

**File:** `public/styles.css`

Add styles for recall verification:

```css
/* Recall text input */
.recall-textarea {
  font-family: 'Courier New', monospace;
  font-size: 1.1rem;
  letter-spacing: 2px;
  text-transform: uppercase;
}

/* Recall feedback */
.recall-feedback {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 1.5rem;
  margin-top: 1rem;
}

.recall-stats {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
}

.recall-stat {
  flex: 1;
  text-align: center;
  padding: 0.5rem;
  border-radius: 4px;
  background: var(--bg-primary);
}

.recall-details {
  display: grid;
  gap: 0.5rem;
}

.recall-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem;
  border-radius: 4px;
}

.recall-item.correct {
  background: #e8f5e9;
  color: #2e7d32;
}

.recall-item.incorrect {
  background: #ffebee;
  color: #c62828;
}

.recall-item.missed {
  background: #fff3e0;
  color: #e65100;
}

.recall-item.extra {
  background: #f5f5f5;
  color: #616161;
}

.recall-icon {
  font-size: 1.2rem;
  font-weight: bold;
}
```

---

## Phase 3: API Integration

### 3.1 Update API Client

**File:** `src/services/api-client.ts`

Update transformation in `createSession`:
```typescript
const backendData = {
  // ... existing fields ...
  user_recall: sessionData.userRecall,
  recall_validation: sessionData.recallValidation
};
```

Update transformation in response mapping:
```typescript
return {
  // ... existing fields ...
  userRecall: backendResponse.user_recall,
  recallValidation: backendResponse.recall_validation
};
```

Apply same changes to `getUserSessions` response mapping.

---

## Key Files Summary

### Files to Create:
1. `src/services/recall-validator.ts` - New validation logic
2. `backend/alembic/versions/004_add_recall_verification.py` - Migration

### Files to Modify:
1. `src/types.ts` - Add RecallValidation interface, update SessionData
2. `src/services/session-manager.ts` - Update finalizeSession signature
3. `src/ui/renderer.ts` - Update renderRatingScreen, add renderRecallFeedback
4. `src/app.ts` - Update handleSaveSession, handleNextPair
5. `public/index.html` - Replace number input with textarea
6. `public/styles.css` - Add recall feedback styles
7. `src/services/api-client.ts` - Map new fields to/from backend
8. `backend/src/models/session.py` - Add user_recall, recall_validation columns
9. `backend/src/schemas/session.py` - Add fields to schemas

### Drill Type Order Requirements:
- **Unordered (Flash Pairs only):** `DrillType.FLASH_PAIRS`
- **Ordered (All others):** `TWO_PAIR_FUSION`, `THREE_PAIR_CHAIN`, `EIGHT_PAIR_CHAIN`, `JOURNEY_MODE`, `FULL_CUBE_SIMULATION`

---

**Please do [docs/features/0004_PLAN.md]**

