# Technical Plan: Align Corner Tracing with Edge Tracing Implementation

## Brief Context

The user wants to verify that corner tracing works the same as edge tracing and use it in the drill. After reviewing both implementations, there are significant inconsistencies between the edge and corner tracing services. The corner tracer needs to be aligned with the edge tracer patterns to ensure consistency in data usage, error handling, logging, and integration with the shared cube models.

## Current Issues Identified

### 1. **Data Source Inconsistency**
- **Edge Tracer**: Uses shared data from `cube-models.ts` (`EDGE_PIECES`, `POSITION_LETTERS`)
- **Corner Tracer**: Has embedded data instead of using `CORNER_PIECES` from `cube-models.ts`

### 2. **Position Mapping Issues**
- **Edge Tracer**: Uses `POSITION_LETTERS` from shared models to map positions
- **Corner Tracer**: Has hardcoded position mapping instead of using shared data

### 3. **Conversion Methods**
- **Edge Tracer**: Has proper `convertFromScramblerCube()` method
- **Corner Tracer**: Has incomplete conversion that returns default colors

### 4. **Error Handling**
- **Edge Tracer**: Comprehensive error handling with fallbacks
- **Corner Tracer**: Missing error handling and safety checks

### 5. **Logging and Debugging**
- **Edge Tracer**: Extensive logging for debugging
- **Corner Tracer**: Minimal logging

## Files to be Modified

### Core Service Files
- `src/services/corner-tracer.ts` - Complete rewrite to match edge tracer patterns
- `src/services/corner-tracing-validator.ts` - Update to use aligned corner tracer

### Supporting Files
- `src/services/move-applier.ts` - Ensure corner conversion methods are consistent
- `src/ui/tracing-renderer.ts` - Verify integration works with updated corner tracer

## Algorithm Step-by-Step

### Phase 1: Data Layer Alignment

1. **Update Corner Tracer to Use Shared Data**:
   - Replace embedded corner notation with `CORNER_PIECES` from `cube-models.ts`
   - Replace hardcoded position mapping with `POSITION_LETTERS` usage
   - Import and use shared types from `cube-models.ts`

2. **Align Data Loading Methods**:
   - `loadCornerNotation()` - Use `CORNER_PIECES` from shared models
   - `loadCubePositions()` - Use `POSITION_LETTERS` like edge tracer
   - `loadCorrelateMap()` - Use shared data for secondary letter mapping

### Phase 2: Core Logic Alignment

3. **Update Core Methods to Match Edge Tracer**:
   - `get_corner_solved_position_by_colors()` - Add error handling like edge tracer
   - `get_secondary_corner_letters()` - Add safety checks and error handling
   - `do_cycle()` - Add logging and error handling like edge tracer
   - `do_full_trace()` - Add comprehensive logging and cycle limits

4. **Add Missing Error Handling**:
   - Add try-catch blocks around critical operations
   - Add fallback mechanisms for invalid states
   - Add warning logs for debugging

### Phase 3: Conversion and Integration

5. **Fix Conversion Methods**:
   - Implement proper `convertFromScramblerCube()` method
   - Add `traceCornersFromScrambler()` export function
   - Ensure conversion handles all corner positions correctly

6. **Add Comprehensive Logging**:
   - Add debug logging to all major methods
   - Add cycle tracking and step counting
   - Add error logging with stack traces

### Phase 4: Testing and Validation

7. **Update Corner Tracing Validator**:
   - Ensure validator uses updated corner tracer methods
   - Verify error handling works correctly
   - Test with various scramble sequences

## Implementation Details

### Key Changes to Corner Tracer

1. **Data Loading**:
```typescript
// Replace embedded data with shared models
import { CORNER_PIECES, POSITION_LETTERS } from '../models/cube-models.js';

private loadCornerNotation(): void {
  for (const [notation, colors] of Object.entries(CORNER_PIECES)) {
    this.cornerNotation.set(notation, colors);
  }
}
```

2. **Position Mapping**:
```typescript
// Use POSITION_LETTERS like edge tracer
private loadCubePositions(): void {
  const cornerLetters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 
                       'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X'];
  
  cornerLetters.forEach(letter => {
    // Find position in POSITION_LETTERS like edge tracer does
    // ... implementation similar to edge tracer
  });
}
```

3. **Error Handling**:
```typescript
// Add comprehensive error handling like edge tracer
public get_secondary_corner_letters_safe(notation: string): string[] {
  try {
    return this.get_secondary_corner_letters(notation);
  } catch (error) {
    console.warn(`Error getting secondary letters for ${notation}:`, error);
    return [];
  }
}
```

4. **Conversion Method**:
```typescript
// Implement proper conversion like edge tracer
public convertFromScramblerCube(scramblerCube: ScramblerCubeState): CornerState {
  const cornerCubeState: CornerState = {};
  
  // Extract corner piece colors using position mapping
  const allCornerPositions = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 
                             'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X'];
  
  for (const position of allCornerPositions) {
    const mainPos = this.cubePositions.get(position);
    const secondaryLetters = this.get_secondary_corner_letters_safe(position);
    
    if (mainPos && secondaryLetters.length === 2) {
      const secondaryPos1 = this.cubePositions.get(secondaryLetters[0]);
      const secondaryPos2 = this.cubePositions.get(secondaryLetters[1]);
      
      if (secondaryPos1 && secondaryPos2) {
        const mainColor = scramblerCube.faces[mainPos.face as keyof typeof scramblerCube.faces].colors[mainPos.row][mainPos.col];
        const secondaryColor1 = scramblerCube.faces[secondaryPos1.face as keyof typeof scramblerCube.faces].colors[secondaryPos1.row][secondaryPos1.col];
        const secondaryColor2 = scramblerCube.faces[secondaryPos2.face as keyof typeof scramblerCube.faces].colors[secondaryPos2.row][secondaryPos2.col];
        
        cornerCubeState[position] = {
          colors: [mainColor, secondaryColor1, secondaryColor2],
          orientation: 'correct'
        };
      }
    }
  }
  
  return cornerCubeState;
}
```

### Expected Outcomes

After implementation:
- Corner tracing will use the same data sources as edge tracing
- Error handling will be consistent between both services
- Logging will provide the same level of debugging information
- Conversion from scrambler cube will work properly
- Integration with the drill system will be seamless
- Both services will follow the same patterns and conventions

## Testing Strategy

1. **Unit Tests**: Test each method individually with known inputs
2. **Integration Tests**: Test full tracing workflow with various scrambles
3. **Error Handling Tests**: Test with invalid inputs and edge cases
4. **Performance Tests**: Ensure tracing completes within reasonable time limits
5. **UI Integration Tests**: Verify drill interface works with updated corner tracer

**Please do [docs/features/0008_PLAN.md]**