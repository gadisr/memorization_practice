# Feature 0008: Sequence Validation

## Brief Context

Add validation functionality for edge tracing drills. The feature will take a scrambled cube (based on a given scramble string) and a tracing sequence provided by the user, then validate if the user's sequence correctly solves the cube. This enables drill-based practice where users can test their edge tracing skills by comparing their traced sequence against the expected solution. The validation process applies the sequence (setup moves + edge swap algorithm + inverse setup moves) to the cube and checks if all edges end up in their correct positions (allowing for flips).

## Technical Implementation

### Phase 1: Data Layer and Models

#### Files to Create/Modify:
- `src/models/sequence-validation.ts` - New models for validation
- `src/data/setup-moves.json` - Setup moves mapping from applying_sequence.txt

#### New Interfaces:
```typescript
interface SetupMove {
  letter: string;
  move: string;
}

interface ValidationResult {
  isValid: boolean;
  finalCubeState: EdgeTracerCubeState;
  edgesInPosition: string[];
  flippedEdges: string[];
  errors: string[];
}

interface SequenceValidationInput {
  scrambleString: string; // Original scramble sequence used to create the cube
  userTracingSequence: string; // User's traced sequence from drill
}

interface DrillValidationResult {
  isValid: boolean;
  expectedSequence: string; // Correct sequence from EdgeTracer
  userSequence: string; // User's input
  finalCubeState: EdgeTracerCubeState;
  edgesInPosition: string[];
  flippedEdges: string[];
  errors: string[];
  score: number; // Percentage of correctness
}
```

#### Setup Moves Data Structure:
Create `src/data/setup-moves.json` with mapping from letters to setup moves:
```json
{
  "a": "Lw2 D' L2",
  "c": "Lw2 D L2", 
  "e": "L' Dw L'",
  "f": "Dw' L",
  "g": "L Dw L'",
  "h": "Dw L'",
  "i": "Lw D' L2",
  "j": "Dw2 L",
  "k": "Lw D L2",
  "l": "L'",
  "n": "Dw L",
  "o": "D' Lw D L2",
  "p": "Dw' L'",
  "q": "Lw' D L2",
  "r": "L",
  "s": "Lw' D' L2",
  "t": "Dw2 L'",
  "u": "D' L2",
  "v": "D2 L2",
  "w": "D L2",
  "x": "L2"
}
```

### Phase 2A: Core Validation Service

#### Files to Create/Modify:
- `src/services/sequence-validator.ts` - Main validation service
- `src/services/move-applier.ts` - Helper for applying moves to cube state

#### Core Algorithm Implementation:
1. **Generate Scrambled Cube**: Use scramble string to create cube state
2. **Get Expected Sequence**: Use EdgeTracer.do_full_trace() to get correct sequence
3. **Parse User Sequence**: Split user's traced sequence into individual letters
4. **Apply User Sequence**: For each letter:
   - Apply setup move to cube
   - Apply edge swap algorithm: `R U R' U' R' F R2 U' R' U' R U R' F'`
   - Apply inverse setup move
5. **Validation Check**: 
   - Check if all edges are in correct positions
   - Allow for flipped edges (correct position, wrong orientation)
   - Compare user sequence with expected sequence
   - Calculate score/percentage of correctness
   - Return detailed drill validation result

#### Key Functions:
```typescript
export function validateDrillSequence(input: SequenceValidationInput): DrillValidationResult
export function scrambleAndValidate(scrambleString: string, userSequence: string): DrillValidationResult
export function applySequenceToCube(cube: EdgeTracerCubeState, sequence: string): EdgeTracerCubeState
export function getInverseSetupMove(setupMove: string): string
export function areAllEdgesInPosition(cube: EdgeTracerCubeState): boolean
export function calculateSequenceScore(expected: string, user: string): number
```

### Phase 2B: Integration and Testing

#### Files to Create/Modify:
- `src/tests/sequence-validator.test.ts` - Comprehensive test suite
- `src/examples/sequence-validation-demo.ts` - Demo implementation

#### Test Cases:
1. Perfect user sequence matches expected sequence
2. User sequence with minor errors (partial correctness)
3. User sequence with major errors (low score)
4. User sequence with flipped edges
5. Edge case: empty user sequence
6. Edge case: user sequence with invalid letters
7. Integration test: scramble cube → get expected → validate user input
8. Drill workflow test: multiple scramble strings with various user inputs

#### Demo Features:
- Interactive drill simulation with scramble string input
- User sequence input interface
- Visual comparison of expected vs user sequences
- Score calculation and feedback
- Detailed validation report with error analysis
- Drill performance tracking

### Phase 3: Move Application Logic

#### Files to Create/Modify:
- `src/services/move-applier.ts` - Convert scrambler move logic for EdgeTracerCubeState

#### Key Requirements:
- Adapt existing `apply_move` function from `cube-scrambler.ts` 
- Convert between `CubeState` (scrambler) and `EdgeTracerCubeState` (tracer)
- Handle all move types: basic (U, R, F, B, D, L), wide (Lw, Dw), and variants ('', '2', "'")
- Implement inverse move calculation for setup moves

#### Move Application Algorithm:
1. **Setup Move Application**: Apply setup move to cube
2. **Edge Swap Application**: Apply the fixed edge swap algorithm
3. **Inverse Setup Application**: Apply inverse of setup move
4. **State Validation**: Check if cube state is valid after each step

### Implementation Details

#### Edge Swap Algorithm:
Fixed sequence: `R U R' U' R' F R2 U' R' U' R U R' F'`

#### Setup Move Processing:
- Parse setup moves from applying_sequence.txt
- Calculate inverse moves (e.g., `Lw2 D' L2` → `L2 D Lw2`)
- Handle all move variants and wide moves

#### Validation Logic:
- After applying full sequence, check each edge position
- Edge is considered "in position" if it's in the correct location (orientation can be flipped)
- Sequence is valid if ALL edges are in position after application

#### Error Handling:
- Invalid sequence letters
- Move parsing errors  
- Cube state corruption
- Missing setup moves

### Dependencies
- Existing `EdgeTracer` class for cube state management
- Existing `CubeState` and move functions from `cube-scrambler.ts`
- Edge notation data from `edge-notation.json`
- Cube positions data from `cube-positions.json`

### Integration Points
- Extends existing edge tracing functionality (EdgeTracer.do_full_trace())
- Uses established cube scrambling infrastructure (scramble_cube function)
- Follows existing TypeScript patterns and interfaces
- Integrates with current testing framework
- Enables drill-based practice workflow: scramble → trace → validate user input
- Provides scoring and feedback for learning progression
- Supports future drill system integration

Please do [docs/features/0008_PLAN.md]
