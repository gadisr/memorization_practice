# Feature 0001: BLD Memory Trainer - Core Application

## Brief Context

Build a lightweight web-based training application for blindfold cubers to improve visualization speed, story fluency, and recall accuracy using personalized letter-pair systems. The app runs offline in the browser, uses localStorage for persistence, and exports training data to CSV. It implements six drill modes with adaptive quality metrics (Vividness 1-5 for short drills, Flow 1-3 for long drills) and automatic timing/logging.

---

## Phase 1: Data Layer

### 1.1 Type Definitions & Data Structures

**File:** `src/types.ts`
- Define `DrillType` enum: `FLASH_PAIRS`, `TWO_PAIR_FUSION`, `THREE_PAIR_CHAIN`, `EIGHT_PAIR_CHAIN`, `JOURNEY_MODE`, `FULL_CUBE_SIMULATION`
- Define `QualityMetric` enum: `VIVIDNESS`, `FLOW`
- Define `LetterPair` interface: `{ pair: string, displayOrder: number, timestamp?: number }`
- Define `DrillConfig` interface:
  ```
  {
    type: DrillType,
    defaultPairCount: number,
    qualityMetric: QualityMetric,
    description: string
  }
  ```
- Define `SessionData` interface:
  ```
  {
    id: string,
    date: string,
    drillType: DrillType,
    pairCount: number,
    pairs: LetterPair[],
    timings: number[],
    averageTime: number,
    recallAccuracy: number,
    vividness?: number,
    flow?: number,
    notes?: string
  }
  ```

### 1.2 Default Configuration Data

**File:** `src/config/drill-config.ts`
- Export `DRILL_CONFIGS` map containing all six drill modes:
  - Flash Pairs: 30 pairs, Vividness metric
  - 2-Pair Fusion: 10 pairs, Vividness metric
  - 3-Pair Chain: 5 pairs, Vividness metric
  - 8-Pair Chain: 8 pairs, Flow metric
  - Journey Mode: 15 pairs, Flow metric
  - Full Cube Simulation: 20 pairs, Flow metric

### 1.3 Letter Pair Reference

**File:** `src/data/pair-reference.json`
- JSON array of all valid letter pairs (e.g., `["AA", "AB", "AC", ..., "ZZ"]`)
- Initially populate with standard A-Z combinations (676 pairs)
- Support future user customization

### 1.4 Storage Layer

**File:** `src/storage/session-storage.ts`
- `saveSession(session: SessionData): void` - Save session to localStorage with key `bld_session_{id}`
- `getAllSessions(): SessionData[]` - Retrieve all sessions sorted by date
- `getSessionsByDateRange(start: string, end: string): SessionData[]`
- `clearAllSessions(): void` - Wipe all stored sessions
- Use localStorage key prefix `bld_trainer_`

---

## Phase 2A: Core Backend Logic

### 2.1 Random Pair Generator

**File:** `src/services/pair-generator.ts`
- `generateRandomPairs(count: number, excludeRepeats?: boolean): LetterPair[]`
  - Algorithm:
    1. Load pairs from pair-reference.json
    2. Shuffle array using Fisher-Yates algorithm
    3. Select first `count` pairs
    4. If `excludeRepeats`, filter out consecutive duplicates
    5. Assign `displayOrder` (0-indexed)
    6. Return array
- `loadPairReference(): string[]` - Load from JSON, cache in memory
- `validatePair(pair: string): boolean` - Check if pair exists in reference

### 2.2 Timer Service

**File:** `src/services/timer.ts`
- `startTimer(): number` - Returns timestamp (Date.now())
- `stopTimer(startTime: number): number` - Returns elapsed time in seconds
- `calculateAverage(timings: number[]): number` - Returns mean with 2 decimal precision
- Maintain array of per-pair timings during session

### 2.3 Session Manager

**File:** `src/services/session-manager.ts`
- `createSession(drillType: DrillType, pairCount?: number): SessionData`
  - Generate unique ID (timestamp + random)
  - Initialize empty timings array
  - Generate pairs using pair-generator
  - Set date to current ISO string
- `recordPairTiming(sessionId: string, timing: number): void`
- `finalizeSession(sessionId: string, recall: number, quality: number, notes?: string): SessionData`
  - Calculate averageTime from timings
  - Set recallAccuracy = (recall / pairCount) * 100
  - Set vividness or flow based on drill config
  - Save to storage
  - Return completed session
- Maintain active session in memory (singleton pattern)

### 2.4 CSV Export Service

**File:** `src/services/csv-exporter.ts`
- `generateCSV(sessions: SessionData[]): string`
  - Algorithm:
    1. Define headers: `Date, Drill, #Pairs, Avg Time (sec), Recall Accuracy (%), Vividness (1-5), Flow (1-3), Notes`
    2. Map each session to CSV row
    3. Handle empty vividness/flow (use "-" for non-applicable)
    4. Escape commas and quotes in notes field
    5. Join rows with newline
    6. Return CSV string
- `downloadCSV(csvContent: string, filename: string): void`
  - Create Blob with type `text/csv`
  - Generate download link
  - Programmatically click to trigger download
  - Clean up object URL

---

## Phase 2B: UI Integration

### 2.5 HTML Structure

**File:** `public/index.html`
- Main container: `<div id="app">`
- Sections:
  - **Setup Screen** (`#setup-screen`):
    - Drill type dropdown (`<select id="drill-select">`)
    - Pair count input (`<input type="number" id="pair-count">`)
    - Start button (`<button id="start-btn">`)
  - **Session Screen** (`#session-screen`, initially hidden):
    - Current pair display (`<div id="current-pair">`)
    - Pair counter (`<span id="pair-counter">`)
    - Next button (`<button id="next-btn">`)
  - **Rating Screen** (`#rating-screen`, initially hidden):
    - Quality rating input (radio buttons or slider)
    - Recall count input (`<input type="number" id="recall-input">`)
    - Notes textarea (`<textarea id="notes-input">`)
    - Save button (`<button id="save-btn">`)
  - **Dashboard Screen** (`#dashboard-screen`, initially hidden):
    - Recent sessions table
    - Export CSV button (`<button id="export-btn">`)
    - New session button

### 2.6 Main Application Controller

**File:** `src/app.ts`
- `initializeApp(): void`
  - Load drill configs into dropdown
  - Attach event listeners
  - Populate default pair counts
  - Render dashboard if sessions exist
- `startSession(): void`
  - Get selected drill type and pair count
  - Call sessionManager.createSession()
  - Show session screen
  - Display first pair
  - Start timer for first pair
- `handleNextPair(): void`
  - Stop current timer
  - Record timing
  - Increment pair index
  - If more pairs: display next pair, start new timer
  - Else: show rating screen with appropriate quality metric
- `handleSaveSession(): void`
  - Get recall count and quality rating
  - Call sessionManager.finalizeSession()
  - Show success message
  - Return to dashboard
  - Update dashboard display
- `handleExportCSV(): void`
  - Get all sessions from storage
  - Generate CSV using csv-exporter
  - Trigger download with filename `bld_training_log_[date].csv`

### 2.7 UI Renderer

**File:** `src/ui/renderer.ts`
- `renderSetupScreen(configs: DrillConfig[]): void`
- `renderSessionScreen(pair: string, currentIndex: number, total: number): void`
- `renderRatingScreen(metric: QualityMetric, pairCount: number): void`
  - If metric is VIVIDNESS: show 1-5 scale with labels
  - If metric is FLOW: show 1-3 scale with labels
- `renderDashboard(sessions: SessionData[]): void`
  - Show recent 10 sessions in table
  - Display summary stats (total pairs, avg accuracy)
- `showScreen(screenId: string): void` - Hide all screens, show specified one
- `showNotification(message: string, type: 'success' | 'error'): void`

### 2.8 Styling

**File:** `public/styles.css`
- Minimalist design: black text on light background
- Large, touch-friendly buttons (min 48px height)
- Clear typography hierarchy
- Responsive layout (mobile-first)
- Simple color scheme:
  - Background: #FAFAFA
  - Text: #212121
  - Primary button: #2196F3
  - Success: #4CAF50
  - Error: #F44336

---

## Phase 3: Enhancements

### 3.1 Adaptive Quality Metric Logic

**File:** `src/services/quality-adapter.ts`
- `getQualityMetric(drillType: DrillType): QualityMetric`
  - Flash Pairs → VIVIDNESS
  - 2-Pair Fusion → VIVIDNESS
  - 3-Pair Chain → VIVIDNESS
  - 8-Pair Chain → FLOW
  - Journey Mode → FLOW
  - Full Cube Simulation → FLOW
- `getQualityScaleLabel(metric: QualityMetric, value: number): string`
  - Vividness: 1="Blurry", 2="Dim", 3="Clear", 4="Vivid", 5="Crystal"
  - Flow: 1="Choppy", 2="Smooth", 3="Seamless"

### 3.2 Data Validation

**File:** `src/utils/validators.ts`
- `validatePairCount(count: number, drillType: DrillType): boolean`
  - Check min=1, max=50
  - Warn if significantly different from default
- `validateRecallCount(recall: number, total: number): boolean`
  - Must be 0 <= recall <= total
- `validateQualityRating(rating: number, metric: QualityMetric): boolean`
  - Vividness: 1-5
  - Flow: 1-3

### 3.3 Keyboard Shortcuts

**File:** `src/ui/keyboard-handler.ts`
- Space bar → Next pair (during session)
- Enter → Save session (on rating screen)
- Numbers 1-5 → Quick quality rating
- Escape → Cancel session (with confirmation)

---

## File Structure Summary

```
memorization_practice/
├── public/
│   ├── index.html
│   └── styles.css
├── src/
│   ├── types.ts
│   ├── app.ts
│   ├── config/
│   │   └── drill-config.ts
│   ├── data/
│   │   └── pair-reference.json
│   ├── services/
│   │   ├── pair-generator.ts
│   │   ├── timer.ts
│   │   ├── session-manager.ts
│   │   ├── csv-exporter.ts
│   │   └── quality-adapter.ts
│   ├── storage/
│   │   └── session-storage.ts
│   ├── ui/
│   │   ├── renderer.ts
│   │   └── keyboard-handler.ts
│   └── utils/
│       └── validators.ts
├── docs/
│   ├── application_brief.md
│   └── features/
│       └── 0001_PLAN.md
└── README.md
```

---

## Key Algorithms

### Fisher-Yates Shuffle (Pair Generator)
```
for i from n-1 down to 1:
  j = random integer with 0 <= j <= i
  swap array[i] with array[j]
```

### Session Flow State Machine
```
SETUP → SESSION_ACTIVE → RATING → SAVED → SETUP
  ↓         ↓                ↓
  └─────────┴────────────────┴──→ CANCELLED → SETUP
```

### Timing Calculation
```
timings = [t1, t2, ..., tn]
averageTime = sum(timings) / length(timings)
roundTo2Decimals(averageTime)
```

---

## Implementation Notes

1. **No Build Step Initially**: Use vanilla JavaScript (ES6 modules) with type comments for TypeScript-like development. Convert to TypeScript build process in Phase 4 if needed.

2. **LocalStorage Limits**: Monitor storage size. Typical limit is 5-10MB. With ~200 bytes per session, can store ~25,000 sessions. Add warning at 80% capacity.

3. **Offline-First**: No external dependencies. All assets bundled. Works without internet.

4. **Browser Compatibility**: Target modern browsers (Chrome 90+, Firefox 88+, Safari 14+). Use ES6+ features freely.

5. **Testing Strategy**: Manual testing for Phase 1. Add Jest unit tests in Phase 4 for session-manager, pair-generator, and csv-exporter.

6. **Accessibility**: Ensure keyboard navigation, ARIA labels, and sufficient color contrast (WCAG AA minimum).

---

## Future Phases (Not In Scope)

- Phase 4: Analytics dashboard with charts
- Phase 5: Google Sheets API integration
- Phase 6: Custom pair library editor
- Phase 7: PWA conversion for mobile installation
- Phase 8: Audio mode for pairs

---

**Please do [docs/features/0001_PLAN.md]**


