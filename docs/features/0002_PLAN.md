# Feature 0002: Cube Notation Training - Edge & Corner Drills

## Brief Context

Add two new drill types for practicing Speffz notation recognition: Edge Notation Drill (2-color pieces) and Corner Notation Drill (3-color pieces). Users are shown colored squares in vertical layout where the top square is always the main color determining the Speffz letter. They must type the correct letter. The system measures time and correctness for each piece, tracking accuracy percentage and average response time. Each drill covers all 24 orientations of edges or corners.

---

## Phase 1: Data Layer

### 1.1 Type Definitions

**File:** `src/types.ts`
- Add to `DrillType` enum:
  - `EDGE_NOTATION_DRILL`
  - `CORNER_NOTATION_DRILL`
- Add new interfaces:
  ```typescript
  export interface CubeColor {
    name: string;      // 'white', 'yellow', 'red', 'orange', 'green', 'blue'
    hex: string;       // hex color code for display
  }
  
  export interface EdgePiece {
    colors: [string, string];  // [top/main, bottom] - top determines notation
    notation: string;          // Speffz letter (A-X)
    displayOrder?: number;
  }
  
  export interface CornerPiece {
    colors: [string, string, string];  // [top, bottom-left, bottom-right] - top determines notation
    notation: string;                  // Speffz letter (A-X)
    displayOrder?: number;
  }
  
  export interface NotationAttempt {
    pieceColors: string[];     // color array shown
    correctAnswer: string;     // Speffz letter
    userAnswer: string;        // what user typed
    isCorrect: boolean;
    timeSeconds: number;
  }
  
  export interface NotationSessionData {
    id: string;
    date: string;
    drillType: DrillType.EDGE_NOTATION_DRILL | DrillType.CORNER_NOTATION_DRILL;
    attempts: NotationAttempt[];
    totalPieces: number;
    correctCount: number;
    accuracy: number;          // percentage
    averageTime: number;       // seconds per piece
    notes?: string;
  }
  ```

### 1.2 Cube Color Reference

**File:** `src/data/cube-colors.json`
```json
{
  "white": "#FFFFFF",
  "yellow": "#FFD700",
  "red": "#E53935",
  "orange": "#FF6F00",
  "green": "#43A047",
  "blue": "#1E88E5"
}
```

### 1.3 Edge Notation Reference (Speffz)

**File:** `src/data/edge-notation.json`
- Map all 24 edge orientations to Speffz letters
- Structure:
  ```json
  [
    { "colors": ["white", "green"], "notation": "C" },
    { "colors": ["green", "white"], "notation": "I" },
    { "colors": ["white", "red"], "notation": "B" },
    { "colors": ["red", "white"], "notation": "M" },
    ...
  ]
  ```
- Complete mapping for 12 edges × 2 orientations = 24 entries (A-X, excluding buffer positions if any)

### 1.4 Corner Notation Reference (Speffz)

**File:** `src/data/corner-notation.json`
- Map all 24 corner orientations to Speffz letters
- Structure:
  ```json
  [
    { "colors": ["white", "green", "red"], "notation": "C" },
    { "colors": ["green", "orange", "yellow"], "notation": "H" },
    { "colors": ["white", "green", "orange"], "notation": "A" },
    ...
  ]
  ```
- Complete mapping for 8 corners × 3 orientations = 24 entries
- Order: [top, bottom-left, bottom-right] where top determines the Speffz letter
- Display as inverted T: top square above, two bottom squares side-by-side

### 1.5 Drill Configuration Updates

**File:** `src/config/drill-config.ts`
- Add configurations:
  ```typescript
  [DrillType.EDGE_NOTATION_DRILL, {
    type: DrillType.EDGE_NOTATION_DRILL,
    defaultPairCount: 24,  // all edge orientations
    qualityMetric: QualityMetric.VIVIDNESS,  // not used for notation drills
    description: 'Recognize Speffz notation from 2-color edge pieces - Accuracy & Speed'
  }],
  [DrillType.CORNER_NOTATION_DRILL, {
    type: DrillType.CORNER_NOTATION_DRILL,
    defaultPairCount: 24,  // all corner orientations
    qualityMetric: QualityMetric.VIVIDNESS,  // not used for notation drills
    description: 'Recognize Speffz notation from 3-color corner pieces - Accuracy & Speed'
  }]
  ```

### 1.6 Storage Layer Updates

**File:** `src/storage/notation-storage.ts` (new file)
- `saveNotationSession(session: NotationSessionData): void`
- `getAllNotationSessions(): NotationSessionData[]`
- `getNotationSessionsByType(drillType: DrillType): NotationSessionData[]`
- Use localStorage key prefix `bld_notation_session_`

---

## Phase 2A: Backend Logic

### 2.1 Piece Generator Service

**File:** `src/services/piece-generator.ts` (new file)
- `loadEdgePieces(): EdgePiece[]`
  - Load from edge-notation.json
  - Cache in memory
- `loadCornerPieces(): CornerPiece[]`
  - Load from corner-notation.json
  - Cache in memory
- `generateRandomEdgeSequence(): EdgePiece[]`
  - Algorithm:
    1. Load all 24 edges
    2. Shuffle using Fisher-Yates
    3. Assign displayOrder
    4. Return shuffled array
- `generateRandomCornerSequence(): CornerPiece[]`
  - Same algorithm for 24 corners

### 2.2 Notation Session Manager

**File:** `src/services/notation-session-manager.ts` (new file)
- `createNotationSession(drillType: DrillType): NotationSessionData`
  - Generate unique ID
  - Load appropriate pieces (edges or corners)
  - Shuffle order
  - Initialize empty attempts array
  - Return session object
- `recordAttempt(sessionId: string, attempt: NotationAttempt): void`
  - Add attempt to session
  - Update correctCount if isCorrect
- `finalizeNotationSession(sessionId: string, notes?: string): NotationSessionData`
  - Calculate accuracy: (correctCount / totalPieces) × 100
  - Calculate averageTime from all attempt times
  - Save to notation-storage
  - Return completed session
- Maintain active notation session in memory

### 2.3 Answer Validation

**File:** `src/services/notation-validator.ts` (new file)
- `validateEdgeAnswer(colors: [string, string], userAnswer: string): { isCorrect: boolean, correctAnswer: string }`
  - Look up correct Speffz letter for color pair
  - Compare with user input (case-insensitive)
  - Return validation result
- `validateCornerAnswer(colors: [string, string, string], userAnswer: string): { isCorrect: boolean, correctAnswer: string }`
  - Look up correct Speffz letter for color triplet
  - Compare with user input (case-insensitive)
  - Return validation result

---

## Phase 2B: UI Integration

### 2.4 HTML Structure Updates

**File:** `public/index.html`
- Add new section: **Notation Training Screen** (`#notation-screen`, initially hidden)
  - Piece counter: `<span id="notation-counter">1 / 24</span>`
  - Color display area: `<div id="color-squares-container">`
    - For edges: 2 vertical squares, top is main (`<div class="color-square">`)
    - For corners: 3 squares - top (main) above, 2 squares side-by-side below (`<div class="color-square">`)
  - Answer input: `<input type="text" id="notation-input" maxlength="1" placeholder="Type letter">`
  - Submit button: `<button id="notation-submit">Submit</button>` or Enter key
  - Feedback display: `<div id="notation-feedback">` (shows correct/incorrect)
  - Timer display: `<span id="notation-timer">0.0s</span>`
- Add to dashboard: Notation session results table

### 2.5 Color Square Renderer

**File:** `src/ui/notation-renderer.ts` (new file)
- `renderEdgeSquares(colors: [string, string]): void`
  - Create 2 div elements with class `color-square`
  - Vertical layout (flex-direction: column)
  - Top square: main color (colors[0]) - determines notation
  - Bottom square: additional color (colors[1])
  - Apply background colors from cube-colors.json
  - Each square: 100px × 100px, 8px gap between
- `renderCornerSquares(colors: [string, string, string]): void`
  - Create 3 div elements
  - Top square (colors[0]): main color - determines notation
  - Bottom row: 2 squares side by side
    - Bottom-left square (colors[1])
    - Bottom-right square (colors[2])
  - Each square: 80px × 80px, 8px gap
- `clearColorSquares(): void` - Remove all squares from container

### 2.6 Notation Session Controller

**File:** `src/app.ts` (extend existing)
- `startNotationSession(drillType: DrillType): void`
  - Create notation session using notation-session-manager
  - Hide setup screen, show notation screen
  - Display first piece
  - Start timer
  - Focus on input field
- `handleNotationSubmit(): void`
  - Get user input from text field
  - Stop timer
  - Validate answer using notation-validator
  - Create NotationAttempt object
  - Record attempt in session
  - Show feedback (correct/incorrect + correct answer if wrong)
  - After 1 second delay:
    - Clear input
    - Increment piece index
    - If more pieces: display next piece, start new timer
    - Else: finalize session, show results
- `handleNotationKeyPress(event: KeyboardEvent): void`
  - Enter key → submit answer
  - Escape → cancel session (with confirmation)
- `showNotationResults(session: NotationSessionData): void`
  - Display accuracy percentage
  - Display average time per piece
  - Show detailed attempts list (optional)
  - Option to save notes
  - Return to dashboard button

### 2.7 Results Display

**File:** `src/ui/notation-renderer.ts`
- `renderNotationResults(session: NotationSessionData): void`
  - Show summary card:
    - Drill type (Edge/Corner)
    - Accuracy: X / 24 correct (XX%)
    - Average time: X.XX seconds
    - Total time: XX.XX seconds
  - Show attempts breakdown (expandable):
    - Each attempt: colors shown, user answer, correct answer, time, ✓/✗
  - Color-code: green for correct, red for incorrect
- `renderNotationSessionsTable(sessions: NotationSessionData[]): void`
  - Add to dashboard table
  - Columns: Date, Type (Edge/Corner), Accuracy, Avg Time, Notes

### 2.8 Styling Updates

**File:** `public/styles.css`
- `.color-square`:
  - Border: 2px solid #333
  - Border-radius: 4px
  - Display: block
  - Box-shadow for depth
- `.color-squares-edge`:
  - Flexbox vertical layout (flex-direction: column)
  - Gap: 8px between squares
  - Square size: 100px × 100px each
  - Center aligned
- `.color-squares-corner`:
  - Top square: 80px × 80px, centered
  - Bottom row: flexbox horizontal with 2 squares
  - Bottom squares: 80px × 80px each
  - Gap: 8px
  - Overall layout forms inverted T shape
- `#notation-input`:
  - Large font size: 48px
  - Centered text
  - Max-width: 100px
  - Auto-uppercase transform
- `.notation-feedback`:
  - Correct: green background, ✓ icon
  - Incorrect: red background, ✗ icon, show correct answer
- `.notation-timer`:
  - Display current time in real-time (update every 100ms)

---

## Phase 3: Data Reference Implementation

### 3.1 Complete Edge Notation Mapping (Speffz)

**Algorithm to populate edge-notation.json:**
1. Define 12 physical edges with their color pairs
2. For each edge, create 2 entries (both orientations)
3. Map to Speffz letters A-X (24 letters total)
4. Standard Speffz edge scheme
   - Examples: white-red = B, red-white = M; white-green = C, green-white = I
   - Note: Exact mappings to be populated based on user's Speffz scheme

### 3.2 Complete Corner Notation Mapping (Speffz)

**Algorithm to populate corner-notation.json:**
1. Define 8 physical corners with their color triplets
2. For each corner, create 3 entries (3 orientations, each showing different top color)
3. Map to Speffz letters A-X (24 letters total)
4. Standard Speffz corner scheme
   - Example: white(top)-green(left)-red(right) = C
   - Example: green(top)-orange(left)-yellow(right) = H
5. Order: [top, bottom-left, bottom-right] where top determines the Speffz letter
6. Display matches this order in inverted T layout

### 3.3 CSV Export Enhancement

**File:** `src/services/csv-exporter.ts` (extend existing)
- Update `generateCSV()` to handle NotationSessionData:
  - Headers: `Date, Drill Type, Total Pieces, Correct, Accuracy (%), Avg Time (sec), Notes`
  - For notation sessions: map drill type to "Edge Notation" or "Corner Notation"
  - Include accuracy and average time metrics
- Support mixed export (regular sessions + notation sessions)

---

## Key Algorithms

### Edge Display Algorithm
```
Input: EdgePiece { colors: [top, bottom], notation }
Output: 2 vertical colored squares (top is main)

1. Create container div with flex-direction: column
2. Create top square:
   - background-color = cube-colors[colors[0]]
   - class = "color-square color-main"
   - Size: 100px × 100px
3. Create bottom square:
   - background-color = cube-colors[colors[1]]
   - class = "color-square color-additional"
   - Size: 100px × 100px
4. Append to container in order: [top, bottom]
5. Add 8px gap between squares
```

### Corner Display Algorithm
```
Input: CornerPiece { colors: [top, bottom-left, bottom-right], notation }
Output: 3 colored squares in inverted T layout (top is main)

1. Create main container with flex-direction: column
2. Create top square:
   - background-color = cube-colors[colors[0]]
   - class = "color-square color-main"
   - Size: 80px × 80px
   - Centered horizontally
3. Create bottom row container with flex-direction: row
4. Create bottom-left square:
   - background-color = cube-colors[colors[1]]
   - class = "color-square"
   - Size: 80px × 80px
5. Create bottom-right square:
   - background-color = cube-colors[colors[2]]
   - class = "color-square"
   - Size: 80px × 80px
6. Add 8px gap between all squares
7. Forms inverted T shape with top determining notation
```

### Attempt Validation Flow
```
1. User types letter → convert to uppercase
2. Stop timer → calculate elapsed time
3. Look up correct answer from piece data
4. Compare: userAnswer === correctAnswer
5. Create NotationAttempt:
   - pieceColors: current piece colors
   - correctAnswer: from reference
   - userAnswer: from input
   - isCorrect: boolean comparison result
   - timeSeconds: elapsed time
6. Record in session
7. Display feedback:
   - If correct: green ✓ + time
   - If incorrect: red ✗ + "Correct: X" + time
8. After 1s delay → next piece or results
```

### Session Completion
```
1. Calculate accuracy:
   accuracy = (correctCount / totalPieces) × 100
2. Calculate average time:
   times = attempts.map(a => a.timeSeconds)
   averageTime = sum(times) / times.length
3. Save session to localStorage
4. Display results screen
5. Update dashboard with new session
```

---

## File Structure Updates

```
memorization_practice/
├── src/
│   ├── types.ts [EXTEND]
│   ├── config/
│   │   └── drill-config.ts [EXTEND]
│   ├── data/
│   │   ├── cube-colors.json [NEW]
│   │   ├── edge-notation.json [NEW]
│   │   └── corner-notation.json [NEW]
│   ├── services/
│   │   ├── piece-generator.ts [NEW]
│   │   ├── notation-session-manager.ts [NEW]
│   │   ├── notation-validator.ts [NEW]
│   │   └── csv-exporter.ts [EXTEND]
│   ├── storage/
│   │   └── notation-storage.ts [NEW]
│   └── ui/
│       └── notation-renderer.ts [NEW]
├── public/
│   ├── index.html [EXTEND]
│   └── styles.css [EXTEND]
└── docs/
    └── features/
        └── 0002_PLAN.md [NEW]
```

---

## Implementation Notes

1. **Letter Input Normalization**: Always convert user input to uppercase for comparison. Speffz uses capital letters A-X.

2. **Timer Precision**: Use `Date.now()` for timestamps, display with 2 decimal places (e.g., "1.23s").

3. **Feedback Timing**: Show feedback for 1 second before advancing to next piece to allow user to process correctness.

4. **Keyboard Focus**: Auto-focus input field when new piece is displayed. Clear input after each submission.

5. **Mobile Optimization**: Color squares should be touch-friendly. Edge squares: 100px × 100px. Corner squares: 80px × 80px. Input should trigger mobile keyboard automatically.

6. **Layout Consistency**: Top square always determines the notation letter. Edges are vertical stacks. Corners are inverted T shape (1 on top, 2 on bottom).

7. **Color Accessibility**: Ensure sufficient contrast for color-blind users. Consider adding optional labels or patterns.

8. **Data Persistence**: Notation sessions stored separately from regular pair sessions. Both should appear in unified dashboard.

9. **Skip/Restart Options**: Add ability to skip current piece (counts as incorrect) or restart session from beginning.

10. **Speffz Reference**: Include helper view/modal showing complete Speffz mapping for both edges and corners (for learning).

11. **Progressive Practice**: Future enhancement could allow practicing specific subsets (e.g., only white edges, only UFR corner orientations).

---

## Validation Checklist

- [ ] All 24 edge orientations mapped correctly to Speffz A-X
- [ ] All 24 corner orientations mapped correctly to Speffz A-X
- [ ] Color hex codes match standard cube colors
- [ ] Edge display: vertical layout, top = main (determines notation), bottom = additional
- [ ] Corner display: inverted T layout, top = main (determines notation), bottom has 2 squares side-by-side
- [ ] Timer starts immediately when piece is shown
- [ ] Timer stops when answer submitted
- [ ] Case-insensitive answer validation
- [ ] Accuracy calculation: (correct / total) × 100
- [ ] Average time calculation: sum(times) / count
- [ ] CSV export includes notation sessions
- [ ] Dashboard shows notation sessions
- [ ] Mobile-responsive color squares
- [ ] Keyboard shortcuts (Enter = submit, Esc = cancel)

---

**Please do [docs/features/0002_PLAN.md]**

